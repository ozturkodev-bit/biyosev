<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>GeliÅŸmiÅŸ YÃ¶netim Paneli</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; padding: 20px; background: #f0f2f5; display: none; color: #333; }
        .container { max-width: 900px; margin: 0 auto; }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 40px; color: #555; }
        
        /* Mesaj KutularÄ± */
        .message-item { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        
        /* Sol taraf: Ä°Ã§erik */
        .msg-content { flex-grow: 1; }
        .author { font-weight: 700; color: #d35400; font-size: 1.1rem; }
        .date { font-size: 0.8rem; color: #999; margin-left: 10px; }
        .text { margin-top: 8px; line-height: 1.5; color: #444; background: #f9f9f9; padding: 8px; border-radius: 5px; }

        /* SaÄŸ taraf: Butonlar */
        .msg-actions { display: flex; flex-direction: column; gap: 5px; min-width: 100px; }
        button { cursor: pointer; padding: 8px 12px; border: none; border-radius: 5px; color: white; font-weight: 600; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        
        .btn-approve { background: #27ae60; } /* YeÅŸil */
        .btn-delete { background: #c0392b; }  /* KÄ±rmÄ±zÄ± */

        /* Duruma gÃ¶re renkler */
        .pending-border { border-left: 5px solid #f39c12; } /* Turuncu */
        .active-border { border-left: 5px solid #27ae60; }  /* YeÅŸil */
        
        .empty-msg { color: #888; font-style: italic; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ”§ YÃ¶netici Paneli</h1>

    <h2>ğŸŸ  Onay Bekleyenler</h2>
    <div id="pendingList">
        <div class="empty-msg">YÃ¼kleniyor...</div>
    </div>

    <h2>ğŸŸ¢ YayÄ±ndaki Mesajlar (Sitede GÃ¶rÃ¼nenler)</h2>
    <div id="activeList">
        <div class="empty-msg">YÃ¼kleniyor...</div>
    </div>
</div>

<script type="module">
    // 1. ÅÄ°FRE GÄ°RÄ°ÅÄ°
    var sifre = prompt("YÃ¶netici Åifresi:");
    if(sifre === "12345") { // Åifreyi deÄŸiÅŸtirebilirsin
        document.body.style.display = "block";
    } else {
        document.body.innerHTML = "<h2 style='text-align:center; color:red; margin-top:50px;'>â›” Yetkisiz GiriÅŸ</h2>";
        throw new Error("YanlÄ±ÅŸ Åifre");
    }

    // 2. FIREBASE KÃœTÃœPHANELERÄ°
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, where, orderBy, doc, updateDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --------------------------------------------------------
    const firebaseConfig = {
  apiKey: "AIzaSyDgKb8OUWeLzHrDhIMOjaMc4dGA_xAHhB0",
  authDomain: "biyosev-defter.firebaseapp.com",
  projectId: "biyosev-defter",
  storageBucket: "biyosev-defter.firebasestorage.app",
  messagingSenderId: "602079219548",
  appId: "1:602079219548:web:a99ff9ab2ad62fc8db3b99",
  measurementId: "G-3ECJQXN693"
};

    // --------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messagesRef = collection(db, "guestbook_messages");

    // === LÄ°STE 1: ONAY BEKLEYENLERÄ° GETÄ°R ===
    const qPending = query(messagesRef, where("status", "==", "beklemede"), orderBy("createdAt", "desc"));
    
    onSnapshot(qPending, (snapshot) => {
        const list = document.getElementById("pendingList");
        list.innerHTML = "";
        
        if(snapshot.empty) {
            list.innerHTML = "<div class='empty-msg'>Åu an onay bekleyen mesaj yok.</div>";
            return;
        }

        snapshot.forEach((doc) => {
            renderMessage(doc, list, "pending");
        });
    });

    // === LÄ°STE 2: YAYINDA OLANLARI GETÄ°R ===
    const qActive = query(messagesRef, where("status", "==", "onaylandi"), orderBy("createdAt", "desc"));
    
    onSnapshot(qActive, (snapshot) => {
        const list = document.getElementById("activeList");
        list.innerHTML = ""; // Temizle
        
        if(snapshot.empty) {
            list.innerHTML = "<div class='empty-msg'>HenÃ¼z yayÄ±nlanmÄ±ÅŸ mesaj yok.</div>";
            return;
        }

        snapshot.forEach((doc) => {
            renderMessage(doc, list, "active");
        });
    });

    // --- MESAJ KUTUSU OLUÅTURUCU ---
    function renderMessage(docSnap, parentElement, type) {
        const data = docSnap.data();
        const id = docSnap.id;
        let dateStr = "Tarih Yok";
        try { if(data.createdAt) dateStr = data.createdAt.toDate().toLocaleString("tr-TR"); } catch(e){}

        const div = document.createElement("div");
        div.className = `message-item ${type === 'pending' ? 'pending-border' : 'active-border'}`;
        
        // Butonlar: Bekleyenlerde 'Onayla' ve 'Sil' var. YayÄ±ndakilerde sadece 'Sil' var.
        let buttonsHtml = "";
        if(type === 'pending') {
            buttonsHtml = `
                <button class="btn-approve" onclick="onayla('${id}')">âœ“ Onayla</button>
                <button class="btn-delete" onclick="sil('${id}')">âœ• Reddet</button>
            `;
        } else {
            buttonsHtml = `
                <button class="btn-delete" onclick="sil('${id}')">ğŸ—‘ï¸ YayÄ±ndan KaldÄ±r</button>
            `;
        }

        div.innerHTML = `
            <div class="msg-content">
                <span class="author">${escapeHtml(data.author)}</span>
                <span class="date">${dateStr}</span>
                <div class="text">${escapeHtml(data.text)}</div>
            </div>
            <div class="msg-actions">
                ${buttonsHtml}
            </div>
        `;
        parentElement.appendChild(div);
    }

    // --- BUTON FONKSÄ°YONLARI ---
    window.onayla = async (id) => {
        try { await updateDoc(doc(db, "guestbook_messages", id), { status: "onaylandi" }); }
        catch(e) { alert("Hata: " + e.message); }
    };

    window.sil = async (id) => {
        if(confirm("Bu mesajÄ± tamamen silmek istediÄŸine emin misin?")) {
            try { await deleteDoc(doc(db, "guestbook_messages", id)); }
            catch(e) { alert("Hata: " + e.message); }
        }
    };

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
</script>

</body>
</html>
